---
import Layout from '../layouts/Layout.astro';
---
<Layout title="Profile">
    <div id="profileView" class="hidden max-w-sm mx-auto mt-4 text-center">
        <div class="relative inline-block mb-4">
            <img id="avatar" src="" class="w-24 h-24 rounded-full border-4 border-blue-500/30 object-cover bg-slate-800">
        </div>
        <h2 id="username" class="text-xl font-bold text-white mb-1">User</h2>
        <p id="rank" class="text-xs font-bold text-blue-400 uppercase tracking-widest mb-6">Novice</p>

        <div class="glass-panel p-4 rounded-xl mb-4 text-left">
             <div class="flex justify-between text-xs text-blue-200 mb-2">
                 <span>Level <span id="lvl">1</span></span>
                 <span id="xp">0 XP</span>
             </div>
             <div class="w-full bg-black/40 h-2 rounded-full overflow-hidden">
                 <div id="bar" class="bg-gradient-to-r from-blue-500 to-purple-500 h-full w-0"></div>
             </div>
        </div>

        <button id="logout" class="w-full bg-red-500/10 text-red-300 py-3 rounded-xl text-xs font-bold border border-red-500/20">Logout</button>
    </div>

    <script>
        const userId = localStorage.getItem('userId');
        
        if(!userId) {
            window.location.href = '/login';
        } else {
            fetch(`/api/user/profile?userId=${userId}`)
            .then(r => r.json())
            .then(user => {
                document.getElementById('profileView').classList.remove('hidden');
                document.getElementById('username').innerText = user.username;
                document.getElementById('avatar').src = user.avatar || `https://api.dicebear.com/7.x/identicon/svg?seed=${user.username}`;
                document.getElementById('lvl').innerText = user.level;
                document.getElementById('xp').innerText = `${user.exp % 100} / 100 XP`;
                document.getElementById('bar').style.width = `${user.exp % 100}%`;
                
                let title = "Novice Reader";
                if(user.level >= 5) title = "Page Turner";
                if(user.level >= 10) title = "Scroll Keeper";
                if(user.level >= 20) title = "Grand Librarian";
                document.getElementById('rank').innerText = title;
            });
        }

        document.getElementById('logout').addEventListener('click', () => {
            localStorage.clear();
            window.location.href = '/';
        });
    </script>
</Layout>