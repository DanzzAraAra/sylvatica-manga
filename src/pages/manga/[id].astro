---
import Layout from '../../layouts/Layout.astro';

const { id } = Astro.params;
let mangaData = null;
let chapters = [];
let mangaDexError = false;

try {
    const res = await fetch(`https://api.jikan.moe/v4/manga/${id}`);
    const json = await res.json();
    mangaData = json.data;

    if (mangaData) {
        const title = mangaData.title;
        const mdSearch = await fetch(`https://api.mangadex.org/manga?title=${encodeURIComponent(title)}&limit=1`);
        const mdSearchData = await mdSearch.json();

        if (mdSearchData.data && mdSearchData.data.length > 0) {
            const mangaDexId = mdSearchData.data[0].id;

            const feed = await fetch(`https://api.mangadex.org/manga/${mangaDexId}/feed?translatedLanguage[]=en&order[chapter]=desc&limit=24`);
            const feedData = await feed.json();
            
            chapters = feedData.data.map(ch => ({
                id: ch.id,
                chap: ch.attributes.chapter,
                title: ch.attributes.title,
                group: ch.relationships.find(r => r.type === 'scanlation_group')?.id
            }));
        } else {
            mangaDexError = true;
        }
    }
} catch (e) {
    console.log(e);
}

if (!mangaData) return Astro.redirect('/404');
---

<Layout title={mangaData.title}>
    <div class="pb-20">
        <div class="relative w-full h-64 md:h-80 rounded-2xl overflow-hidden mb-8 shadow-2xl border border-white/10">
            <img src={mangaData.images.webp.large_image_url} class="absolute inset-0 w-full h-full object-cover opacity-60 blur-sm">
            <div class="absolute inset-0 bg-gradient-to-t from-[#1a1b26] via-transparent to-transparent"></div>
            
            <div class="absolute bottom-0 left-0 p-6 flex items-end gap-6 w-full">
                <img src={mangaData.images.webp.image_url} class="w-32 rounded-lg shadow-xl border-2 border-white/20 hidden md:block">
                <div class="flex-1">
                    <h1 class="text-3xl font-bold text-white mb-2 font-serif drop-shadow-md">{mangaData.title}</h1>
                    <div class="flex flex-wrap gap-2 text-xs">
                        {mangaData.genres.map(g => (
                            <span class="bg-blue-600/30 px-2 py-1 rounded text-blue-100 border border-blue-500/30 backdrop-blur-md">{g.name}</span>
                        ))}
                        <span class="bg-purple-600/30 px-2 py-1 rounded text-purple-100 border border-purple-500/30 backdrop-blur-md">{mangaData.status}</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="mb-8 px-2">
            <h3 class="text-lg font-bold text-blue-200 mb-2">Synopsis</h3>
            <p class="text-white/70 text-sm leading-relaxed">{mangaData.synopsis}</p>
        </div>

        <div class="px-2">
            <h3 class="text-lg font-bold text-purple-200 mb-4">
                Chapters
            </h3>

            {mangaDexError ? (
                <div class="p-6 bg-red-900/20 border border-red-500/30 rounded-xl text-center text-red-200 text-sm">
                    Manga not found on Reader Server. <br>Try searching the title directly in Library.
                </div>
            ) : chapters.length === 0 ? (
                <div class="p-6 bg-white/5 rounded-xl text-center text-white/40 text-sm animate-pulse">
                    Loading chapters or no English translation available...
                </div>
            ) : (
                <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-3">
                    {chapters.map(ch => (
                        <a href={`/read/${ch.id}`} class="bg-white/5 hover:bg-blue-600/20 border border-white/10 hover:border-blue-500/50 p-4 rounded-xl transition group">
                            <div class="flex items-center justify-between mb-1">
                                <span class="text-white font-bold group-hover:text-blue-300">Ch. {ch.chap}</span>
                                <svg class="w-4 h-4 text-white/20 group-hover:text-blue-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0l-7 7m7-7H3" /></svg>
                            </div>
                            <p class="text-xs text-white/40 truncate">{ch.title || `Chapter ${ch.chap}`}</p>
                        </a>
                    ))}
                </div>
            )}
        </div>
    </div>
</Layout>
